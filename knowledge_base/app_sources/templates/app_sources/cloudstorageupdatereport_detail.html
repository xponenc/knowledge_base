{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<style>
    .table td {
        max-width: 200px; /* –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É —è—á–µ–π–∫–∏ */
        word-break: break-all; /* –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç —Å–ª–æ–≤–∞ –ø–æ –ª—é–±–æ–º—É —Å–∏–º–≤–æ–ª—É */
        overflow-wrap: break-word; /* –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ */
        white-space: normal; /* –†–∞–∑—Ä–µ—à–∞–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ */
    }
</style>
{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mt-3 mb-3">
    <ol class="breadcrumb container">
        <li class="breadcrumb-item"><a href="{{ object.storage.kb.get_absolute_url }}">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π {{ object.storage.kb.title }}</a></li>
        <li class="breadcrumb-item">
            <a href="{% url 'sources:cloudstorage_detail' object.storage.pk %}">
                –û–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ {{ object.storage.name }}
            </a>
        </li>
        <li class="breadcrumb-item active" aria-current="page">–û—Ç—á–µ—Ç –ø–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</li>
    </ol>
</nav>
{% endblock %}

{% block title %}–û—Ç—á–µ—Ç –ø–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏{% endblock %}

{% block content %}
<div class="sync-report">
    <h1 class="sync-report__title mb-4">–û—Ç—á–µ—Ç –ø–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h1>

    <div class="sync-report__meta text-muted mb-3 d-flex justify-content-between">
        <div class="sync-report__info text-start" style="flex:1;">
            <a href="{% url 'sources:cloudstorage_detail' cloudstorageupdatereport.storage.pk %}" class="link-primary fw-semibold">
                {{ cloudstorageupdatereport.storage.name }}
            </a>
            <p class="text-muted fst-italic mb-1">–ê–≤—Ç–æ—Ä —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {{ cloudstorageupdatereport.created_at }}</p>
            <p class="text-muted fst-italic mb-1">–î–∞—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {{ cloudstorageupdatereport.author.get_full_name|default:cloudstorageupdatereport.author }}</p>
            <p class="text-muted fst-italic mb-1">–¢–∏–ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {{ cloudstorageupdatereport.content.type }}</p>
            <p class="text-muted mb-1">–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏: {{ cloudstorageupdatereport.get_status_display }}</p>
        </div>
        <div class="sync-report__tasks me-3" style="flex:1;">
            <h5>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏</h5>
            <ul class="list-unstyled">
                {% for task_data in task_context %}
                <li class="d-flex align-items-center mb-2">
                    <a href="{% url 'celery_progress_info' 'cloudstorageupdatereport' cloudstorageupdatereport.pk task_data.task_id %}" class="me-2">{{ task_data.task_name }}</a>
                    {% if task_data.report.status == "PENDING" %}
                        <span class="badge bg-secondary" title="–û–∂–∏–¥–∞–µ—Ç">‚è≥</span>
                    {% elif task_data.report.status == "STARTED" %}
                        <span class="badge bg-info text-dark" title="–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è">‚öôÔ∏è</span>
                    {% elif task_data.report.status == "SUCCESS" %}
                        <span class="badge bg-success" title="–£—Å–ø–µ—à–Ω–æ">‚úîÔ∏è</span>
                    {% elif task_data.report.status == "FAILURE" %}
                        <span class="badge bg-danger" title="–û—à–∏–±–∫–∞">‚ùå</span>
                    {% elif task_data.report.status == "RETRY" %}
                        <span class="badge bg-warning text-dark" title="–ü–æ–≤—Ç–æ—Ä">üîÑ</span>
                    {% else %}
                        <span class="badge bg-light text-dark" title="{{ task_data.report.status }}">{{ task_data.report.status }}</span>
                    {% endif %}
                </li>
                {% empty %}
                <li>–§–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    
    {% with result=cloudstorageupdatereport.content.result %}
    <h4 class="mt-4">–°–≤–æ–¥–∫–∞ –ø–æ –≥—Ä—É–ø–ø–∞–º</h4>
    <table class="table table-bordered mb-5 w-auto">
        <thead class="table-light">
            <tr>
                <th>–ì—Ä—É–ø–ø–∞</th>
                <th>–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ</th>
                <th>–£—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ</th>
            </tr>
        </thead>
        <tbody>
            <tr class="table-success">
                <td>–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã</td>
                <td>{{ result.new_files|length }}</td>
                <td>{{ created_network_documents|length }}</td>
            </tr>
            <tr class="table-warning">
                <td>–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ñ–∞–π–ª—ã</td>
                <td>{{ result.exist_documents|length }}</td>
                <td>-</td>
            </tr>
            <tr class="table-danger">
                <td>–£–¥–∞–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</td>
                <td>{{ result.deleted_files|length }}</td>
                <td>-</td>
            </tr>
            <tr class="table-primary">
                <td>–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</td>
                <td>{{ result.restored_files|length }}</td>
                <td>-</td>
            </tr>
            <tr class="table-secondary">
                <td>–ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</td>
                <td>{{ result.excluded_files|length }}</td>
                <td>-</td>
            </tr>
        </tbody>
    </table>

    {# === –ë–ª–æ–∫: –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã === #}
    <div class="sync-report__section mb-5">
        <h3 class="text-success">–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã ({{ result.new_files|length }})</h3>
        {% if created_network_documents %}
            <table class="table table-bordered table-hover">
                <thead class="table-success">
                    <tr>
                        <th>–ò–º—è</th>
                        <th>–ö–æ–Ω—Ç–µ–Ω—Ç</th>
                        <th>–ò–Ω—Ñ–æ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for networkdocument in created_network_documents %}
                        <tr>
                            <td>{{ networkdocument.title|default:networkdocument.path }}</td>
                            <td>
                                {% if networkdocument.created_rawcontent %}
                                    <p class="mb-1">
                                        <strong>üì• –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª ({{ networkdocument.created_rawcontent.file.size|filesizeformat }}): </strong>
                                        <a href="{{ networkdocument.created_rawcontent.file.url }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                            ‚¨á –°–∫–∞—á–∞—Ç—å
                                        </a>
                                    </p>
                                {% else %}
                                    –û–®–ò–ë–ö–ê
                                {% endif %}
                            </td>
                            <td>
                                <p class="mb-0">–°—Ç–∞—Ç—É—Å: {{ networkdocument.status }}</p>
                                <p class="mb-0">URL: {{ networkdocument.url }}</p>
                                <p class="mb-0">–Ø–∑—ã–∫: {{ networkdocument.language }}</p>
                                <p class="mb-0">–ù–∞–∑–≤–∞–Ω–∏–µ: {{ networkdocument.title }}</p>
                                <p class="mb-0">–¢—ç–≥–∏: {{ networkdocument.tags }}</p>
                                <p class="mb-0">–û—à–∏–±–∫–∏: {{ networkdocument.error_message }}</p>
                                <p class="mb-0">–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: {{ networkdocument.metadata }}</p>
                                <p class="mb-0">–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ –∏—Å—Ç–æ—á–Ω–∏–∫–µ: {{ networkdocument.remote_updated }}</p>
                                <p class="mb-0">–î–∞—Ç–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è ?:?{{ networkdocument.local_updated }}</p>
                                <p class="mb-0">–î–∞—Ç–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ ?:?{{ networkdocument.synchronized_at }}</p>
                                <p class="mb-0">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: {{ networkdocument.created_at }}</p>
                                <p class="mb-0">–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: {{ networkdocument.updated_at }}</p>
                                <p class="mb-0">–î–∞—Ç–∞ –º—è–≥–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è: {{ networkdocument.soft_deleted_at }}</p>
                                <p class="mb-0">–•—Ä–∞–Ω–∏–ª–∏—â–µ: {{ networkdocument.storage }}</p>
                                <p class="mb-0">–°–æ–∑–¥–∞–Ω –≤ —Ä–∞–º–∫–∞—Ö –æ—Ç—á–µ—Ç–∞: {{ networkdocument.report }}</p>
                                <p class="mb-0">–ü—É—Ç—å: {{ networkdocument.path }}</p>
                                <p class="mb-0">ID –Ω–∞ –æ–±–ª–∞—á–Ω–æ–º –¥–∏—Å–∫:–µ{{ networkdocument.file_id }}</p>
                                <p class="mb-0">–§–æ—Ä–º–∞—Ç –≤—ã–≤–æ–¥–∞ –≤ –ë–î: {{ networkdocument.output_format }}</p>
                                <p class="mb-0">–û–ø–∏—Å–∞–Ω–∏–µ: {{ networkdocument.description }}</p>
                            </td>
                            
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p class="text-muted">–ù–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
        {% endif %}
    </div>

    {# === –ë–ª–æ–∫: –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã === #}
    <div class="sync-report__section mb-5">
        <h3 class="text-warning">–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã ({{ result.updated_files|length }})</h3>
        {% if result.updated_files %}
            {% with updated_docs=cloudstorageupdatereport.content.updated_docs|default:0 %}
            {% if updated_docs != result.updated_files|length %}
            <form method="post" action="{% url 'sources:documents-mass-update' cloudstorageupdatereport.pk %}" class="mb-3 p-3 border rounded bg-light">
                {% csrf_token %}
                <p class="form-text mb-2">–í—ã–±–µ—Ä–∏—Ç–µ, –¥–ª—è –∫–∞–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –æ–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã:</p>
                <div class="mb-2">
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="toggleAllCheckboxes('updated_files')">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAllCheckboxes('updated_files', false)">–û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ</button>
                </div>
                <button type="submit" class="btn btn-warning mt-2 mb-4">–û–±–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>
            {% else %}
            <p class="text-muted">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —É–∂–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã.</p>
            {% endif %}

            <table class="table table-bordered table-hover">
                <thead class="table-warning">
                    <tr>
                        {% if updated_docs != result.updated_files|length %}
                        <th></th>
                        {% endif %}
                        <th>–ò–º—è</th>
                        <th>–ü—É—Ç—å</th>
                        <th>–†–∞–∑–º–µ—Ä</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file_id, file in result.updated_files.items %}
                    <tr>
                        {% if created_count != result.updated_files|length and not file.doc_id %}
                        <td>
                            <input type="checkbox" name="file_ids" value="{{ file_id }}" class="form-check-input updated_files-checkbox">
                        </td>
                        {% endif %}
                        <td>{{ file.file_name }}</td>
                        <td>{{ file.path }}</td>
                        <td>{{ file.size|filesizeformat }}</td>
                        <td>
                            {% if file.doc_updated %}
                            <span class="text-warning">–æ–±–Ω–æ–≤–ª—ë–Ω</span>
                            {% else %}
                            {{ file.process_status|default:"–≥–æ—Ç–æ–≤ –∫ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é" }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if updated_docs != result.updated_files|length %}
            </form>
            {% endif %}
            {% endwith %}
        {% else %}
        <p class="text-muted">–û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
        {% endif %}
    </div>

    {# === –ë–ª–æ–∫: –£–¥–∞–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã === #}
    <div class="sync-report__section mb-5">
        <h3 class="text-danger">–£–¥–∞–ª—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã ({{ result.deleted_files|length }})</h3>
        {% if result.deleted_files %}
            {% with deleted_docs=cloudstorageupdatereport.content.deleted_docs|default:0 %}
            {% if deleted_docs != result.deleted_files|length %}
            <form method="post" action="{% url 'sources:documents-mass-delete' cloudstorageupdatereport.pk %}" class="mb-3 p-3 border rounded bg-light">
                {% csrf_token %}
                <p class="form-text mb-2">–í—ã–±–µ—Ä–∏—Ç–µ, –¥–ª—è –∫–∞–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ —É–¥–∞–ª–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã:</p>
                <div class="mb-2">
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="toggleAllCheckboxes('deleted_files')">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAllCheckboxes('deleted_files', false)">–û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ</button>
                </div>
                <button type="submit" class="btn btn-danger mt-2 mb-4">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>
            {% else %}
            <p class="text-muted">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —É–∂–µ —É–¥–∞–ª–µ–Ω—ã.</p>
            {% endif %}

            <table class="table table-bordered table-hover">
                <thead class="table-danger">
                    <tr>
                        {% if deleted_docs != result.deleted_files|length %}
                        <th></th>
                        {% endif %}
                        <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th>–ü—É—Ç—å</th>
                        <th>ID</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file_id, file in result.deleted_files.items %}
                    <tr>
                        {% if created_count != result.deleted_files|length and not file.doc_id %}
                            <td>
                                <input type="checkbox" name="file_ids" value="{{ file_id }}" class="form-check-input deleted_files-checkbox">
                            </td>
                        {% endif %}
                        <td>{{ file.title }}</td>
                        <td>{{ file.path }}</td>
                        <td>{{ file.id }}</td>
                        <td>
                            {% if file.doc_deleted %}
                            <span class="text-danger">—É–¥–∞–ª—ë–Ω</span>
                            {% else %}
                            {{ file.process_status|default:"–≥–æ—Ç–æ–≤ –∫ —É–¥–∞–ª–µ–Ω–∏—é" }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if deleted_docs != result.deleted_files|length %}
            </form>
            {% endif %}
            {% endwith %}
        {% else %}
        <p class="text-muted">–£–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
        {% endif %}
    </div>

    {# === –ë–ª–æ–∫: –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã === #}
    <div class="sync-report__section mb-5">
        <h3 class="text-primary">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã ({{ result.restored_files|length }})</h3>
        {% if result.restored_files %}
            {% with restored_docs=cloudstorageupdatereport.content.restored_docs|default:0 %}
            {% if restored_docs != result.restored_files|length %}
            <form method="post" action="{% url 'sources:documents-mass-restore' cloudstorageupdatereport.pk %}" class="mb-3 p-3 border rounded bg-light">
                {% csrf_token %}
                <p class="form-text mb-2">–í—ã–±–µ—Ä–∏—Ç–µ, –¥–ª—è –∫–∞–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã:</p>
                <div class="mb-2">
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="toggleAllCheckboxes('restored_files')">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAllCheckboxes('restored_files', false)">–û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ</button>
                </div>
                <button type="submit" class="btn btn-primary mt-2 mb-4">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>
            {% else %}
            <p class="text-muted">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —É–∂–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã.</p>
            {% endif %}

            <table class="table table-bordered table-hover">
                <thead class="table-primary">
                    <tr>
                        {% if restored_docs != result.restored_files|length %}
                        <th></th>
                        {% endif %}
                        <th>–ò–º—è</th>
                        <th>–ü—É—Ç—å</th>
                        <th>–†–∞–∑–º–µ—Ä</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file_id, file in result.restored_files.items %}
                    <tr>
                        {% if created_count != result.restored_files|length and not file.doc_id %}
                            <td>
                                <input type="checkbox" name="file_ids" value="{{ file_id }}" class="form-check-input restored_files-checkbox">
                            </td>
                        {% endif %}
                        <td>{{ file.file_name }}</td>
                        <td>{{ file.path }}</td>
                        <td>{{ file.size|filesizeformat }}</td>
                        <td>
                            {% if file.doc_restored %}
                            <span class="text-primary">–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                            {% else %}
                            {{ file.process_status|default:"–≥–æ—Ç–æ–≤ –∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é" }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if restored_docs != result.restored_files|length %}
            </form>
            {% endif %}
            {% endwith %}
        {% else %}
        <p class="text-muted">–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
        {% endif %}
    </div>

    {# === –ë–ª–æ–∫: –ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã === #}
    <div class="sync-report__section mb-5">
        <h3 class="text-secondary">–ò—Å–∫–ª—é—á—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã ({{ result.excluded_files|length }})</h3>
        {% if result.excluded_files %}
            {% with excluded_docs=cloudstorageupdatereport.content.excluded_docs|default:0 %}
            {% if excluded_docs != result.excluded_files|length %}
            <form method="post" action="{% url 'sources:documents-mass-exclude' cloudstorageupdatereport.pk %}" class="mb-3 p-3 border rounded bg-light">
                {% csrf_token %}
                <p class="form-text mb-2">–í—ã–±–µ—Ä–∏—Ç–µ, –¥–ª—è –∫–∞–∫–∏—Ö —Ñ–∞–π–ª–æ–≤ –∏—Å–∫–ª—é—á–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã:</p>
                <div class="mb-2">
                    <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="toggleAllCheckboxes('excluded_files')">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleAllCheckboxes('excluded_files', false)">–û—Ç–º–µ–Ω–∏—Ç—å –≤—Å–µ</button>
                </div>
                <button type="submit" class="btn btn-secondary mt-2 mb-4">–ò—Å–∫–ª—é—á–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>
            {% else %}
            <p class="text-muted">–í—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ –∏—Å–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ —É–∂–µ –∏—Å–∫–ª—é—á–µ–Ω—ã.</p>
            {% endif %}

            <table class="table table-bordered table-hover">
                <thead class="table-secondary">
                    <tr>
                        {% if excluded_docs != result.excluded_files|length %}
                        <th></th>
                        {% endif %}
                        <th>–ò–º—è</th>
                        <th>–ü—É—Ç—å</th>
                        <th>–ü—Ä–∏—á–∏–Ω–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file_id, file in result.excluded_files.items %}
                    <tr>
                        {% if created_count != result.excluded_files|length and not file.doc_id %}
                            <td>
                                <input type="checkbox" name="file_ids" value="{{ file_id }}" class="form-check-input excluded_files-checkbox">
                            </td>
                        {% endif %}
                        <td>{{ file.file_name }}</td>
                        <td>{{ file.path }}</td>
                        <td>{{ file.reason|default:"-" }}</td>
                        <td>
                            {% if file.doc_excluded %}
                            <span class="text-secondary">–∏—Å–∫–ª—é—á—ë–Ω</span>
                            {% else %}
                            {{ file.process_status|default:"–≥–æ—Ç–æ–≤ –∫ –∏—Å–∫–ª—é—á–µ–Ω–∏—é" }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if excluded_docs != result.excluded_files|length %}
            </form>
            {% endif %}
            {% endwith %}
        {% else %}
        <p class="text-muted">–ò—Å–∫–ª—é—á—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</p>
        {% endif %}
    </div>

    {% endwith %}
</div>
{% endblock %}

{% block script %}
<script>
    function toggleAllCheckboxes(section, checked = true) {
        document.querySelectorAll(`.${section}-checkbox`).forEach(cb => cb.checked = checked);
        console.log(`toggleAllCheckboxes: set all checkboxes in ${section} to ${checked}`);
        updateButtonState(section);
    }
    
    function updateButtonState(section) {
        console.log(`.${section}-checkbox`)
        const checkboxes = document.querySelectorAll(`.${section}-checkbox`);
        console.log(checkboxes)
        console.log(document.querySelector(`.${section}-checkbox`)?.closest('form'))
        const submitButton = document.querySelector(`.${section}-checkbox`)?.closest('form')?.querySelector('button[type="submit"]');
    
        if (!submitButton) {
            console.log(`updateButtonState: submit button for section ${section} not found`);
            return;
        }
    
        const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
        console.log(`updateButtonState: anyChecked = ${anyChecked}`);
    
        submitButton.disabled = !anyChecked;
        console.log(`updateButtonState: submitButton.disabled = ${submitButton.disabled}`);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—à–∞—Ç–µ–ª–∏ –Ω–∞ –≤—Å–µ —á–µ–∫–±–æ–∫—Å—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener('DOMContentLoaded', () => {
        ['new_files', 'updated_files', 'deleted_files', 'restored_files', 'excluded_files'].forEach(section => {
            const checkboxes = document.querySelectorAll(`.${section}-checkbox`);
            checkboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    console.log(`Checkbox changed in section ${section}`);
                    updateButtonState(section);
                });
            });
            // –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
            updateButtonState(section);
        });
    });
    

    function toggleAllCheckboxes(section, checked = true) {
        document.querySelectorAll(`.${section}-checkbox`).forEach(cb => {
            cb.checked = checked;
    
            // –°–æ–∑–¥–∞—ë–º –∏ —Ç—Ä–∏–≥–≥–µ—Ä–∏–º —Å–æ–±—ã—Ç–∏–µ change
            const event = new Event('change', { bubbles: true });
            cb.dispatchEvent(event);
        });
    }
</script>
{% endblock %}