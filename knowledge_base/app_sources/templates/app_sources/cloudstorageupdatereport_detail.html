{% extends "base.html" %}
{% load static %}
{% block title %}–û—Ç—á–µ—Ç –ø–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏{% endblock %}

{% block content %}
<div class="sync-report">
    <h1 class="sync-report__title mb-4">–û—Ç—á–µ—Ç –ø–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h1>

    <div class="sync-report__meta text-muted mb-3 d-flex justify-content-between">
        
        <div class="sync-report__info text-start" style="flex:1;">
            {{ cloudstorageupdatereport.created_at|date:"F j, Y, H:i" }}<br>
            <a href="{% url 'sources:cloudstorage_detail' cloudstorageupdatereport.storage.pk %}" class="link-primary fw-semibold">
                {{ cloudstorageupdatereport.storage.name }}
            </a>

            <p>–¢–∏–ø —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏: {{ cloudstorageupdatereport.content.sync_type }}</p>
            <p>–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏: {{ cloudstorageupdatereport.content.current_status }}</p>
        </div>
        
        <div class="sync-report__tasks me-3" style="flex:1;">
            <h5>–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–µ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏</h5>
            <ul class="list-unstyled">
            {% for task_data in task_context %}
                <li class="d-flex align-items-center mb-2">
                    <a href="{% url 'celery_progress_info' 'cloudstorageupdatereport' cloudstorageupdatereport.pk task_data.task_id %}" class="me-2">{{ task_data.task_name }}</a>
                    {% if task_data.report.status == "PENDING" %}
                        <span class="badge bg-secondary" title="–û–∂–∏–¥–∞–µ—Ç">‚è≥</span>
                    {% elif task_data.report.status == "STARTED" %}
                        <span class="badge bg-info text-dark" title="–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è">‚öôÔ∏è</span>
                    {% elif task_data.report.status == "SUCCESS" %}
                        <span class="badge bg-success" title="–£—Å–ø–µ—à–Ω–æ">‚úîÔ∏è</span>
                    {% elif task_data.report.status == "FAILURE" %}
                        <span class="badge bg-danger" title="–û—à–∏–±–∫–∞">‚ùå</span>
                    {% elif task_data.report.status == "RETRY" %}
                        <span class="badge bg-warning text-dark" title="–ü–æ–≤—Ç–æ—Ä">üîÑ</span>
                    {% else %}
                        <span class="badge bg-light text-dark" title="{{ task_data.report.status }}">{{ task_data.report.status }}</span>
                    {% endif %}
                </li>
            {% empty %}
                <li>–§–æ–Ω–æ–≤—ã—Ö –∑–∞–¥–∞—á –Ω–µ—Ç</li>
            {% endfor %}
            </ul>
        </div>

    </div>
    {% with cloudstorageupdatereport.content.result as result %}

    {% if result.new_files %}
    <div class="sync-report__section mb-5">
        <h3 class="sync-report__heading text-success">–ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã ({{ result.new_files|length }})</h3>
        {% if not cloudstorageupdatereport.content.created_docs %}
        <form action="{% url 'sources:documents-mass-create' cloudstorageupdatereport.pk %}" method="post" class="sync-report__form mb-4 p-3 border rounded bg-light">
            {% csrf_token %}
            <p class="form-text mb-2">–ë—É–¥—É—Ç —Å–æ–∑–¥–∞–Ω—ã –Ω–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏–∑ —Ñ–∞–π–ª–æ–≤, –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.</p>
            <button type="submit" class="btn btn-success">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</button>
        </form>
        {% endif %}
        <table class="table table-bordered table-hover">
            <thead class="table-success">
                <tr>
                    <th>–ò–º—è</th>
                    <th>–ü—É—Ç—å</th>
                    <th>–†–∞–∑–º–µ—Ä</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                </tr>
            </thead>
            <tbody>
                {% for file in result.new_files %}
                <tr>
                    <td>{{ file.file_name }}</td>
                    <td><a href="">{{ file.path }}</a></td>
                    <td>{{ file.size|filesizeformat }}</td>
                    <td>{{ file.process_status|default:"–≥–æ—Ç–æ–≤ –∫ —Å–æ–∑–¥–∞–Ω–∏—é" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if result.updated_files %}
    <div class="sync-report__section mb-5">
        <h3 class="sync-report__heading text-warning">–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã ({{ result.updated_files|length }})</h3>
        <table class="table table-bordered table-hover">
            <thead class="table-warning">
                <tr>
                    <th>–ò–º—è</th>
                    <th>–ü—É—Ç—å</th>
                    <th>–†–∞–∑–º–µ—Ä</th>
                </tr>
            </thead>
            <tbody>
                {% for file in result.updated_files %}
                <tr>
                    <td>{{ file.file_name }}</td>
                    <td>{{ file.path }}</td>
                    <td>{{ file.size|filesizeformat }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if result.deleted_files %}
    <div class="sync-report__section mb-5">
        <h3 class="sync-report__heading text-danger">–£–¥–∞–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã ({{ result.deleted_files|length }})</h3>
        <table class="table table-bordered table-hover">
            <thead class="table-danger">
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ü—É—Ç—å</th>
                    <th>ID</th>
                </tr>
            </thead>
            <tbody>
                {% for file in result.deleted_files %}
                <tr>
                    <td>{{ file.title }}</td>
                    <td>{{ file.path }}</td>
                    <td>{{ file.id }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    {% if not result.new_files and not result.updated_files and not result.deleted_files %}
    <p class="text-muted">–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.</p>
    {% endif %}

    {% endwith %}
</div>
{% endblock %}
