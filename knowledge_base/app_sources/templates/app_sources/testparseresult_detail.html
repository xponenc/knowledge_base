{% extends "base.html" %}

{% block title %}–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞</h5>
        </div>
        <div class="card-body">
            <p><strong>üîó URL:</strong> <a href="{{ report.url }}" target="_blank">{{ report.url }}</a></p>

            <hr>

            <h6 class="mt-4">üõ† –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä—Å–µ—Ä:</h6>
            <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—Å–µ—Ä–∞:</strong> {{ parser.name }}</p>
            <p><strong>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:</strong></p>
            {% if report.parser_config %}
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>–ö–ª—é—á</th>
                            <th>–ó–Ω–∞—á–µ–Ω–∏–µ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for key, value in report.parser_config.items %}
                            <tr>
                                <td>{{ key }}</td>
                                <td>
                                    {% if value is string %}
                                        {{ value }}
                                    {% elif value is iterable and value is not string %}
                                        {{ value|join:", " }}
                                    {% else %}
                                        {{ value|default:"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" }}
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class="text-muted">–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç.</p>
            {% endif %}

            <hr>

            <h6 class="mt-4">üì¶ –†–µ–∑—É–ª—å—Ç–∞—Ç:</h6>
            {% if report.parsed_data %}
                <div class="parsed-result">
                    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ content -->
                    {% if report.parsed_data.content %}
                        <div class="mb-4">
                            <h5 class="text-primary">Content</h5>
                            <div class="markdown-content">
                                {{ report.parsed_data.content|linebreaksbr }}
                                {% comment %} {% autoescape off %}
                                    {{ report.parsed_data.content|safe }}  {# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ content —É–∂–µ –æ—Ç—Ä–µ–Ω–¥–µ—Ä–µ–Ω #}
                                {% endautoescape %} {% endcomment %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö, –∏—Å–∫–ª—é—á–∞—è files -->
                    {% for key, value in report.parsed_data.metadata.items %}
                        {% if key != 'files' %}
                            <div class="mb-4">
                                <h5 class="text-primary">{{ key|title }}</h5>
                                {% if key == 'tags' %}
                                    <ul class="list-group">
                                        {% for tag in value %}
                                            <li class="list-group-item">{{ tag }}</li>
                                        {% endfor %}
                                    </ul>
                                {% elif key == 'external_links' or key == 'internal_links' %}
                                    <ul class="list-group">
                                        {% for link_text, link_url in value %}
                                            <li class="list-group-item">
                                                {{ link_text }}: <a href="{{ link_url }}" target="_blank">{{ link_url }}</a>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted">{{ value|default:"–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö" }}</p>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}

                    <!-- –û—Ç–¥–µ–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è –¥–ª—è files -->
                    {% if report.parsed_data.metadata.files %}
                        <div class="mb-4">
                            <h5 class="text-primary">Files</h5>
                            <div class="files-section">
                                {% if report.parsed_data.metadata.files.images %}
                                    <h6 class="mt-2">Images</h6>
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                                <th>–°—Å—ã–ª–∫–∞</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for image_name, image_url in report.parsed_data.metadata.files.images %}
                                                <tr>
                                                    <td>{{ image_name }}</td>
                                                    <td><a href="{{ image_url }}" target="_blank">{{ image_url }}</a></td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                {% endif %}
                                {% if report.parsed_data.metadata.files.documents %}
                                    <h6 class="mt-2">Documents</h6>
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                                <th>–°—Å—ã–ª–∫–∞</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for doc_text, doc_url in report.parsed_data.metadata.files.documents %}
                                                <tr>
                                                    <td>{{ doc_text }}</td>
                                                    <td><a href="{{ doc_url }}" target="_blank">{{ doc_url }}</a></td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                {% endif %}
                                {% if not report.parsed_data.metadata.files.images and not report.parsed_data.metadata.files.documents %}
                                    <p class="text-muted">–ù–µ—Ç —Ñ–∞–π–ª–æ–≤</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                </div>
            {% else %}
                <p class="text-danger">–ü–∞—Ä—Å–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç.</p>
            {% endif %}

            <hr>

            <a href="{% url 'sources:website_parse' website.pk %}?mode=test" class="btn btn-outline-secondary">
                ‚¨Ö –ù–∞–∑–∞–¥ –∫ —Ñ–æ—Ä–º–µ
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .markdown-content img {
        max-width: 100%;
        height: auto;
    }
    .markdown-content a {
        color: #007bff;
        text-decoration: none;
    }
    .markdown-content a:hover {
        text-decoration: underline;
    }
    .files-section h6 {
        font-weight: bold;
        margin-top: 1rem;
    }
</style>
{% endblock %}