{% extends 'clear_base.html' %}
{% load static %}
{% load humanize %}
{% load custom_filters %}

{% block extra_css %}
    <link href="{% static 'css/pagination.css' %}" rel="stylesheet">
    <link href="{% static 'css/storage.css' %}" rel="stylesheet">
    <link href="{% static 'css/grader.css' %}" rel="stylesheet">
{% endblock %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="breadcrumb-wrapper">
    <ol class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
        <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a href="{{ cloudstorage.kb.get_absolute_url }}" itemprop="item">
            <span itemprop="name">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π {{ cloudstorage.kb.title }}</span>
        </a>
        <meta itemprop="position" content="1" />
        </li>
        <li class="breadcrumb-item active" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" aria-current="page">
        <span itemprop="name">{{ cloudstorage.name }}</span>
        <meta itemprop="position" content="2" />
        </li>
    </ol>
</nav>
{% endblock %}

{% block title %}{{ cloudstorage.name }}{% endblock %}

{% block content %}
<div class="page page--cloud">
    <div class="page__top page__grid">
        <div class="page__info info-page _jc-fs">
            <span class="info-page__banner">–û–ë–õ–ê–ö–û</span>
            <div class="info-page__header">
                <h2 class="page__heading">{{ cloudstorage.name }}</h2>
                <h3 class="info-page__heading">–î–µ—Ç–∞–ª–∏ –æ–±–ª–∞—á–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞</h3>
            </div>
            <div class="info-page__body">
                <h3 class="info-page__heading"></h3>
                <dl class="description">
                    <dt class="description__term">üîåAPI</dt>
                    <dd class="description__defination">
                        {{ cloudstorage.api_type }}
                    </dd>
                    <dt class="description__term">üîê –£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (—Ç–æ–∫–µ–Ω —Ö–µ—à–∏—Ä–æ–≤–∞–Ω)</dt>
                    <dd class="description__defination">
                        {{ cloudstorage.credentials|default:"‚Äî" }}
                    </dd>
                    <dt class="description__term">üÜî ID</dt>
                    <dd class="description__defination">
                        <pre class="text">{{ cloudstorage.pk }}</pre> 
                    </dd>
                </dl>
            </div>
            <div class="info-page__footer">
                <div class="btns _jc-fe">
                    <form action="{% url 'sources:cloudstorage_sync' cloudstorage.pk %}" method="POST" class="mb-4">
                        {% csrf_token %}
                        <button type="submit" class="btn btn--reset btn--simple">
                            üîÑ –ü–æ–ª–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±–ª–∞–∫–∞
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <div class="page__reports reports">
            <div class="reports__header">
                <h3 class="reports__heading _ta-e">–û—Ç—á–µ—Ç—ã –ø–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</h3>
            </div>
            <div class="reports__body">
                <table class="elastic-table elastic-table_2-auto _mb">
                    <thead class="elastic-table__thead">
                        <tr class="elastic-table__tr">
                            <th class="elastic-table__th">–æ—Ç—á–µ—Ç</th>
                            <th class="elastic-table__th">—Å—Ç–∞—Ç—É—Å</th>
                        </tr>
                    </thead>
                    <tbody class="elastic-table__tbody">
                        {% for report in update_reports_last %}
                            <tr class="elastic-table__tr">
                                <td class="elastic-table__td">
                                    <a href="{% url 'sources:cloudstorageupdatereport_detail' report.pk %}" class="link-marker">
                                        <div class="elastic-table__cell">
                                            <span>–û—Ç—á–µ—Ç –æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏</span>
                                            <span>{{ report.created_at|date:"d.m.Y H:i" }}</span>
                                            <span>{{ report.author.get_full_name|default:report.author.username }}</span>
                                        </div>
                                        <svg class="link-marker__marker">
                                            <use xlink:href="{% static 'img/icons/sprite.svg' %}#gears"></use>
                                        </svg>
                                    </a>
                                </td>
                                <td class="elastic-table__td">
                                    {% with report.get_status_display as status %}
                                    {% if report.status == "cr" %}
                                        <span class="tag tag--warning">
                                            {{ status }}
                                        </span>
                                    {% elif report.status == "er" %}
                                        <span class="tag tag--alarm">
                                            {{ status }}
                                        </span>
                                    {% else %}
                                        <span class="tag tag--success">
                                            {{ status }}
                                        </span>
                                    {% endif %}
                                {% endwith %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="reports__footer">
                {% if update_report_count > 3 %}
                <div class="btns _jc-fe">
                    <a href="{% url 'sources:cloudstorageupdatereport_list' %}?storage={{ cloudstorage.pk }}" class="link-marker">
                        <span>–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –æ—Ç—á–µ—Ç—ã</span>
                        <svg class="link-marker__marker">
                            <use xlink:href="{% static 'img/icons/sprite.svg' %}#gears"></use>
                        </svg>
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <article class="page__content">
        <h3 class="page__subheading">üóÇÔ∏è –ò—Å—Ç–æ—á–Ω–∏–∫–∏</h3>
        <form class="page__grader form" action="" method="GET" id="network-document-filter-form">
            {% csrf_token %}
            {% comment %} {% include "widgets/_form_content-widget.html" %} {% endcomment %}
            <div class="form__container">
                <div class="field-container field-container_wide">
                    <div class="grader grader--bg">
                        <div class="grader__top">
                            <p class="grader__name text text_upper text_transparent text_micro">—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</p>
                            <div class="grader__icons">
                                <svg class="grader__icon grader__icon_filter visually-hidden">
                                    <use xlink:href="{% static 'img/icons/sprite.svg' %}#filter2"></use>
                                </svg>
                                <svg class="grader__icon grader__icon_ascending js-icon-ascending visually-hidden">
                                    <use xlink:href="{% static 'img/icons/sprite.svg' %}#sorted"></use>
                                </svg>
                                <svg class="grader__icon grader__icon_descending js-icon-descending visually-hidden">
                                    <use xlink:href="{% static 'img/icons/sprite.svg' %}#sorted"></use>
                                </svg>
                                <svg class="grader__icon grader__icon_unsort">
                                    <use xlink:href="{% static 'img/icons/sprite.svg' %}#unsorted"></use>
                                </svg>
                            </div>
                        </div>
                        <div class="grader__help">
                            <div class="grader__help-icon grader__icon grader__icon_info" onClick="showHelp(event)">
                                <svg>
                                    <use xlink:href="{% static 'img/icons/sprite.svg' %}#info2"></use>
                                </svg>
                            </div>
                            <div class="grader__help-text">
                                –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–µ–≤—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã.
                            </div>
                        </div>
                        <div class="grader__body">
                            <div class="grader__section">
                                <div class="grader__header">
                                    <h5 class="grader__heading">—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è </h5>
                                </div>
                                <div class="grader__content">
                                    {% for filter_name, filter_choices in filters.items %}
                                        {% for filter_value, filter_display_name in filter_choices %}
                                            <label class="grader__checkbox checkbox-filter" aria-label="–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è {{ filter_display_name }}">
                                                <input type="checkbox" class="checkbox-filter__input visually-hidden js-filter js-filter-checkbox" name="{{ filter_name }}" value="{{ filter_value }}"{% if request.GET|getlist:filter_name == filter_value %} checked{% endif %} autocomplete="off" onchange="graderChexboxChange(event)">
                                                <span class="checkbox-filter__box"></span>
                                                <span class="checkbox-filter__text">{{ filter_display_name }}</span>
                                            </label>
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                                <div class="grader__header">
                                    <h5 class="grader__heading">–†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ</h5>
                                </div>
                                <div class="grader__content grader__range range-grader">
                                    <div class="range-grader__container">
                                        <label class="range-grader__label" for="date_from">
                                            <span>c </span>
                                        </label>
                                        <input class="range-grader__date js-filter" type="date" id="date_from" name="date_from" autocomplete="off" onchange="graderChexboxChange(event)"/>
                                        <label class="range-grader__label" for="date_from"><span> –ø–æ </span>
                                        </label>
                                        <input class="range-grader__date js-filter" type="date" id="date-to" name="date-to" autocomplete="off" onchange="graderChexboxChange(event)"/>
                                    </div>
                                </div>
                                <div class="grader__header">
                                    <h5 class="grader__heading">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</h5>
                                </div>
                                <div class="grader__content">
                                    {% for sorting_value, sorting_name in sorting_list %}
                                        <label class="grader__checkbox checkbox-filter" aria-label="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ {{ sorting_name }}">
                                            <input type="radio" class="checkbox-filter__input visually-hidden js-sort {% if sorting_value|slice:":1" == "-" %} js-sort-ascending{% else %} js-sort-descending{% endif %}" name="sorting" value="{{ sorting_value }}" onchange="graderChexboxChange(event)">
                                            <svg class="checkbox-filter__icon {% if sorting_value|slice:":1" == "-" %} checkbox-filter__icon_ascending{% else %} checkbox-filter__icon_descending{% endif %}">
                                                <use xlink:href="{% static 'img/icons/sprite.svg' %}#sorted"></use>
                                            </svg>
                                            <span class="checkbox-filter__text">{{ sorting_name }}</span>
                                        </label>
                                    {% endfor %}
                                    <label class="grader__checkbox checkbox-filter" aria-label="–æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É">
                                        <input type="checkbox" class="checkbox-filter__input visually-hidden js-reset-sort" checked onchange="processGraderResetSort(event)">
                                        <svg class="checkbox-filter__icon">
                                            <use xlink:href="{% static 'img/icons/sprite.svg' %}#unsorted"></use>
                                        </svg>
                                        <span class="checkbox-filter__text">–æ—Ç–º–µ–Ω–∏—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="field-container field-container_wide">
                    <label class="custom-field">
                        <input class="custom-field__input" type="text" name="search" value="{{ search_query|default:'' }}" placeholder=" ">
                        <span class="custom-field__placeholder">–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, URL –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é</span>
                    </label>
                </div>
                <button type="submit" class="btn btn--reset btn--round btn--accent" aria-label="–û—Ç–ø—Ä–∞–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å" title="–û—Ç–ø—Ä–∞–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å">
                    <svg class="btn__icon">
                        <use xlink:href="{% static 'img/icons/sprite.svg' %}#search"></use>
                    </svg>
                </button>
            </div>
        <form>
        <div class="page__wrapper" id="network-documents-container">
            {% include "app_sources/include/network_documents_page.html" %}
        </div>
    
    </article>
</div>


{% endblock %}

{% block script %}
<script src="{% static 'js/grader.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const container = document.querySelector('#network-documents-container');
        const form = document.querySelector('#network-document-filter-form');

        function fetchAndUpdate(url) {
            fetch(url, {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                container.innerHTML = data.html;
                window.history.pushState({}, '', url); // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ URL –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏
                syncCheckboxesFromURL();
            });
        }

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(form);
            const params = new URLSearchParams(formData);
            const url = `${window.location.pathname}?${params.toString()}`;
            fetchAndUpdate(url);
        });

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç –∫–ª–∏–∫–æ–≤ –ø–æ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å .closest)
        container.addEventListener('click', function (e) {
            const link = e.target.closest('.pagination__link');
            if (link && container.contains(link)) {
                e.preventDefault();
                const url = link.getAttribute('href');
                fetchAndUpdate(url);
            }
        });

        function syncCheckboxesFromURL() {
            const params = new URLSearchParams(window.location.search);
            document.querySelectorAll('.js-filter').forEach(input => {
                const values = params.getAll(input.name);
                input.checked = values.includes(input.value);
            });
        }
    });
</script>
{% endblock script %}


