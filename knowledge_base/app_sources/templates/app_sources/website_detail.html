{% extends 'base.html' %}
{% load static %}
{% load status_tags %}
{% load humanize %}

{% block extra_css %}
<link href="{% static 'css/pagination.css' %}" rel="stylesheet">
{% endblock extra_css %}

{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="mt-5">
    <ol class="breadcrumb container">
        <li class="breadcrumb-item"><a href="{{ website.kb.get_absolute_url }}">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π {{ website.kb.title }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">{{ website.name }}</li>
    </ol>
</nav>
{% endblock %}

{% block title %}{{ website.name }}{% endblock %}

{% block content %}
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">üìÅ –î–µ—Ç–∞–ª–∏ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –í–µ–±-—Å–∞–π—Ç: {{ website.name }}</h5>
    </div>
    <div class="card-body">
        <dl class="row mb-0">
            <dt class="col-sm-3">üÜî ID</dt>
            <dd class="col-sm-9">{{ website.pk }}</dd>

            <dt class="col-sm-3">üè∑Ô∏è –ù–∞–∑–≤–∞–Ω–∏–µ</dt>
            <dd class="col-sm-9">{{ website.name }}</dd>

            <dt class="col-sm-3">üîå –û—Å–Ω–æ–≤–Ω–∞—è —Å—Å—ã–ª–∫–∞</dt>
            <dd class="col-sm-9">{{ website.base_url }}</dd>

            <dt class="col-sm-3">üîå –°–°—ã–ª–∫–∞ –Ω–∞ XML –∫–∞—Ä—Ç—É</dt>
            <dd class="col-sm-9">{{ website.base_url }}</dd>

        </dl>
    </div>
</div>

<div class="row">
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–µ—Ä -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–µ—Ä
            </div>
            <div class="card-body">
                <p class="text-muted fst-italic mb-2">
                    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –ø–∞—Ä—Å–∏–Ω–≥–∞ –≤—Å–µ–≥–æ —Å–∞–π—Ç–∞. –ï–≥–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–ª–∏—è–µ—Ç –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É.
                </p>
                {% if website.mainparser %}
                <div class="mb-3 border-bottom pb-2">
                    <h5 class="card-title">{{ website.mainparser.class_name }}</h5>
                    <p class="card-text"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ website.mainparser.description|default:"‚Äî" }}</p>
                    <p class="card-text"><strong>–ê–≤—Ç–æ—Ä:</strong> {{ website.mainparser.author }}</p>
                    <p class="card-text"><strong>–°–æ–∑–¥–∞–Ω:</strong> {{ website.mainparser.created_at }}</p>
                    <p class="card-text"><strong>–û–±–Ω–æ–≤–ª—ë–Ω:</strong> {{ website.mainparser.updated_at }}</p>

                    <a href="{% url 'parsers:mainparser_detail' website.mainparser.id %}" class="btn btn-sm btn-outline-primary mt-2" target="_blank">
                        –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏
                    </a>
                </div>
                <a href="{% url 'sources:website_bulk_parse' website.pk %}" class="btn btn-success">
                    üì¶ –ü–∞—Ä—Å–∏–Ω–≥ –ø–æ —Å–ø–∏—Å–∫—É
                </a>
                <a href="{% url 'sources:website_synchronization' website.pk %}" class="btn btn-success">
                    üì¶ –ü–æ–ª–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è
                </a>
                {% else %}
                    <p class="text-muted">–û—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–µ—Ä –Ω–µ –∑–∞–¥–∞–Ω</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- –¢–µ—Å—Ç–æ–≤—ã–µ –ø–∞—Ä—Å–µ—Ä—ã -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                –¢–µ—Å—Ç–æ–≤—ã–µ –ø–∞—Ä—Å–µ—Ä—ã
            </div>
            <div class="card-body">
                <p class="text-muted fst-italic mb-2">
                    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞. –¢–µ—Å—Ç–∏—Ä—É–µ—Ç—Å—è –∑–∞–¥–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å –∏ –≤—ã–¥–∞–µ—Ç—Å—è –æ—Ç—á–µ—Ç –æ –ø–∞—Ä—Å–∏–Ω–≥–µ. 
                    –í –¥–µ—Ç–∞–ª—è–∂ –¢–µ—Å—Ç–æ–≤–æ–≥–æ –ø–∞—Ä—Å–µ—Ä–∞ –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ–≥–æ –û—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä—Å–µ—Ä
                </p>

                {% for test_parser in website.test_parsers.all %}
                    <div class="mb-3 border-bottom pb-2">
                        <h6>{{ test_parser.class_name }}</h6>
                        <p class="mb-1"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ test_parser.description|default:"‚Äî" }}</p>
                        <p class="mb-1"><strong>–ê–≤—Ç–æ—Ä:</strong> {{ test_parser.author }}</p>
                        <p class="mb-1"><strong>–°–æ–∑–¥–∞–Ω:</strong> {{ test_parser.created_at }}</p>
                        
                        {% if test_parser.testparsereport %}
                            <div class="mt-2 ms-3">
                                <p class="fw-bold">–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞:</p>
                                <p class="mb-1"><strong>URL:</strong> <a href="{{ test_parser.testparsereport.url }}" target="_blank">{{ test_parser.testparsereport.url }}</a></p>
                                <p class="mb-1"><strong>–°—Ç–∞—Ç—É—Å:</strong> {{ test_parser.testparsereport.status }}</p>
                                <p class="mb-1 text-danger"><strong>–û—à–∏–±–∫–∞:</strong> {{ test_parser.testparsereport.error|default:"‚Äî" }}</p>
                                <p class="mb-1"><strong>–î–∞—Ç–∞:</strong> {{ test_parser.testparsereport.created_at }}</p>
                                
                                <a href="{% url 'parsers:testparser_detail' test_parser.id %}" class="btn btn-sm btn-outline-primary mt-2" target="_blank">
                                    –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏
                                </a>
                            </div>
                        {% else %}
                            <p class="text-muted">–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç</p>
                        {% endif %}
                    </div>
                {% empty %}
                    <p class="text-muted">–¢–µ—Å—Ç–æ–≤—ã—Ö –ø–∞—Ä—Å–µ—Ä–æ–≤ –Ω–µ—Ç</p>
                {% endfor %}
                <a href="{% url 'sources:website_test_parse' website.pk %}" class="btn btn-outline-primary">
                    üß™ –¢–µ—Å—Ç–æ–≤—ã–π –ø–∞—Ä—Å–∏–Ω–≥
                </a>
            </div>
        </div>
    </div>
</div>
    
    


{% if website.reports.all %}
    <div class="mb-4">
        <h5>üìä –û—Ç—á–µ—Ç—ã</h5>
        <ul>
            {% for report in website.reports.all %}
                <li>
                    <a href="{{ report.get_absolute_url }}">{{ report }}</a>
                </li>
            {% endfor %}
        </ul>
    </div>
{% endif %}


<h3 class="mb-4">üóÇÔ∏è –ö–æ–Ω—Ç–µ–Ω—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞</h3>
<div class="mb-4 border-primary border-1 rounded-1">
    <p class="text-muted fst-italic mb-2">
        –ü–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞ - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ c —Å–µ—Ä–∏–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º–∏ pickle —á–∞–Ω–∫–∞–º (—Ñ–æ—Ä–º–∞—Ç Langchain Document) –ø–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–µ–Ω—Ç—É 
    </p>
    <p class="font-monospace bg-light p-3 rounded">
            with open(file_path, 'rb') as f:<br>
            &nbsp;&nbsp;&nbsp;&nbsp;# –ó–∞–≥—Ä—É–∂–∞–µ–º (–¥–µ—Å–µ—Ä–∏–∞–ª–∏–∑—É–µ–º) —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏–∑ —Ñ–∞–π–ª–∞<br>
            &nbsp;&nbsp;&nbsp;&nbsp;all_documents = pickle.load(f)
        </p>
    <form method="post" action="{% url 'chunks:create_chunks_from_website' website.pk %}" class="mb-3" id="create-chunks-form">
        {% csrf_token %}
       
        {% for key, value in request.GET.items %}
            <input type="hidden" name="{{ key }}" value="{{ value }}">
        {% endfor %}
        <button type="submit" class="btn btn-primary" id="submit-btn">
            –°–æ–∑–¥–∞—Ç—å —á–∞–Ω–∫–∏
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="loader"></span>
        </button>
    </form>
</div>

<!-- –§–æ—Ä–º–∞ —Ñ–∏–ª—å—Ç—Ä–∞ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
<form method="get" class="mb-4">
    <div class="row g-3 align-items-end">
        <div class="col-md-3">
            <label for="search" class="form-label">–ü–æ–∏—Å–∫</label>
            <input type="text" id="search" name="search" class="form-control" value="{{ search_query }}">
        </div>
        <div class="col-md-3">
            <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏</label>
            <select id="status" name="status" class="form-select">
                <option value="">---</option>
                {% for value, name in status_choices %}
                    <option value="{{ value }}" {% if request.GET.status == value %}selected{% endif %}>{{ name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-3">
            <label for="response_status" class="form-label">–ö–æ–¥ HTTP –æ—Ç–≤–µ—Ç–∞</label>
            <input type="text" id="response_status" name="response_status" class="form-control" value="{{ request.GET.response_status }}">
        </div>
        <div class="col-md-3">
            <label for="min_body_length" class="form-label">–î–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –æ—Ç</label>
            <input type="number" id="min_body_length" name="min_body_length" class="form-control" value="{{ request.GET.min_body_length }}">
        </div>
        <div class="col-md-3">
            <label for="min_body_length" class="form-label">–î–ª–∏–Ω–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–æ</label>
            <input type="number" id="min_body_length" name="max_body_length" class="form-control" value="{{ request.GET.max_body_length }}">
        </div>
        <div class="col-md-3">
            <label for="ordering" class="form-label">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</label>
            <select id="ordering" name="ordering" class="form-select">
                <option value="">---</option>
                <option value="latest_content_status" {% if request.GET.ordering == 'latest_content_status' %}selected{% endif %}>–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ ‚Üë</option>
                <option value="-latest_content_status" {% if request.GET.ordering == '-latest_content_status' %}selected{% endif %}>–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ ‚Üì</option>
                <option value="latest_content_response_status" {% if request.GET.ordering == 'latest_content_response_status' %}selected{% endif %}>HTTP-–æ—Ç–≤–µ—Ç ‚Üë</option>
                <option value="-latest_content_response_status" {% if request.GET.ordering == '-latest_content_response_status' %}selected{% endif %}>HTTP-–æ—Ç–≤–µ—Ç ‚Üì</option>
                <option value="latest_content_body_length" {% if request.GET.ordering == 'latest_content_body_length' %}selected{% endif %}>–î–ª–∏–Ω–∞ body ‚Üë</option>
                <option value="-latest_content_body_length" {% if request.GET.ordering == '-latest_content_body_length' %}selected{% endif %}>–î–ª–∏–Ω–∞ body ‚Üì</option>
            </select>
        </div>
        <div class="col-md-12">
            <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>
</form>

{% include "include/pagination.html" %}


<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4">
    {% if search_query %}
        <div class="alert alert-info">
            –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –ø–æ <strong>"{{ search_query }}"</strong>
            {% if request.GET.status or request.GET.response_status or request.GET.min_body_length or request.GET.max_body_length or request.GET.ordering %}
                —Å –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã–º–∏ —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π
            {% endif %}
        </div>
    {% endif %}
    {% for url in page_obj %}
        <div class="col">
            <div class="card h-100 shadow-sm border 
                {% if url.latest_content_error_message %}
                    border-danger bg-danger-subtle text-danger
                {% else %}
                    border-success
                {% endif %}">

                <div class="card-body d-flex flex-column justify-content-between">
                    <h5 class="card-title text-center">
                        <a href="{% url 'sources:url_detail' url.pk %}"
                            class="text-decoration-none text-primary d-flex flex-column align-items-center">
                            <i class="bi {{ raw.get_icon_class }} fs-3 mb-3"></i>
                            <span>{{ url.latest_content_title|default:"–ë–µ–∑ –∏–º–µ–Ω–∏" }}</span>
                        </a>
                    </h5>

                    <div class="small mt-3">
                        <p class="mb-1"><strong>URL:</strong> <span class="text-muted">{{ url.url }}</span></p>
                        <p class="mb-1"><strong>–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏:</strong> {{ url.latest_content_status|get_status_display }}</p>
                        <p class="mb-1"><strong>HTTP-–æ—Ç–≤–µ—Ç:</strong> {{ url.latest_content_response_status|default:"‚Äî" }}</p>
                        <p class="mb-1"><strong>–¢—ç–≥–∏:</strong> {{ url.latest_content_tags|default:"‚Äî" }}</p>
                        <p class="mb-1"><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∏–º–≤–æ–ª–æ–≤ –≤ –∫–æ–Ω—Ç–µ–Ω—Ç–µ:</strong> {{ url.latest_content_body_length|default:"‚Äî" }}</p>

                        {% if url.latest_content_error_message %}
                            <p class="mt-2 mb-0"><strong>–û—à–∏–±–∫–∞:</strong> {{ url.latest_content_error_message }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    {% empty %}
        <p class="text-muted">–ù–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö URL</p>
    {% endfor %}
</div>

{% include "include/pagination.html" %}
{% endblock %}

{% block script %}
    <script>
        document.getElementById('create-chunks-form').addEventListener('submit', function(event) {
            event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

            const submitBtn = document.getElementById('submit-btn');
            const loader = document.getElementById('loader');
            const form = this;

            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            submitBtn.disabled = true;
            submitBtn.innerHTML = '–û–±—Ä–∞–±–æ—Ç–∫–∞... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            loader.classList.remove('d-none');

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —á–µ—Ä–µ–∑ fetch
            fetch(form.action, {
                method: 'POST',
                body: new FormData(form),
                headers: {
                    'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                // –°–æ–∑–¥–∞—ë–º —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'chunk.pickle'; // –ò–º—è —Ñ–∞–π–ª–∞
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);

                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                submitBtn.disabled = false;
                submitBtn.innerHTML = '–°–æ–∑–¥–∞—Ç—å —á–∞–Ω–∫–∏';
                loader.classList.add('d-none');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —á–∞–Ω–∫–æ–≤');
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
                submitBtn.disabled = false;
                submitBtn.innerHTML = '–°–æ–∑–¥–∞—Ç—å —á–∞–Ω–∫–∏';
                loader.classList.add('d-none');
            });
        });
    </script>
{% endblock script%}