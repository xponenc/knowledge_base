{% extends 'clear_base.html' %}
{% load static %}
{% load custom_filters %}


{% block extra_css %}
    <link href="{% static 'libs/choices/choices.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/custom_choices.css' %}" rel="stylesheet">
    <link href="{% static 'css/chat.css' %}" rel="stylesheet">
    <link href="{% static 'css/assistant.css' %}" rel="stylesheet">

{% endblock %}


{% block nav %}
    {% include "include/nav.html" %}
{% endblock nav %}


{% block title %}–°–∏—Å—Ç–µ–º–Ω—ã–π —á–∞—Ç —Å AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–æ–º{% endblock %}



{% block breadcrumbs %}
<nav aria-label="breadcrumb" class="breadcrumb-wrapper">
    <ol class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
        {% comment %} –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π {% endcomment %}
        <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="{{ kb.get_absolute_url }}" itemprop="item">
                <span itemprop="name">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π {{ kb.name }}</span>
            </a>
        <meta itemprop="position" content="1" />
        </li>
        <li class="breadcrumb-item" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="{{ assistant.get_absolute_url }}" itemprop="item">
                <span itemprop="name">AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç ({{ assistant.name }})</span>
            </a>
            <meta itemprop="position" content="2" />
        </li>
        <li class="breadcrumb-item active" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem" aria-current="page">
            <span itemprop="name">–°–∏—Å—Ç–µ–º–Ω—ã–π —á–∞—Ç —Å AI ({{ assistant.name }})</span>
            <meta itemprop="position" content="3" />
        </li>
    </ol>
</nav>
{% endblock %}


{% block content %}
<div class="page page--assistant">
    <div class="page__top page__top--system-chat">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ß–∞—Ç -->
        <div class="chat">
            <div class="chat__header">
                <h3 class="chat__heading">{{ assistant.name }} ({{ assistant.get_type_display }})</h3>
                <span class="text text--muted">Embedded by: <span class="text text--fat text--muted">{{ kb.engine.model_name }}</span></span>
                <span class="text text--muted _mb">Answer by: <span class="text text--fat text--muted">OpenAI/gpt-4o-mini</span></span>
            </div>
            <div class="chat__history" id="chat-history">
                {% for message in chat_history %}
                    <div class="message {% if message.is_user %} message--user{% else %} message--ai{% endif %}" data-message-id="{{ message.id }}" data-url="{% url 'chat:message_score' message.id %}">
                        {{ message.text|safe }}
                        {% if not message.is_user %}
                            <div class="rating" data-score="{{ message.score|default_if_none:'' }}">
                                <div class="rating__stars">
                                    {% for i in "2 1 0 -1 -2"|split:" " %}
                                        {% with i_int=i|add:"0" %}
                                            <label class="rating__star">
                                                <input type="radio" class="rating__input" name="score-{{ message.id }}" value="{{ i_int }}" {% if message.score == i_int%} checked{% endif %}>
                                            </label>
                                        {% endwith %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <div class="chat__footer">
                <form action="{% url 'chat:clear_chat' kb.pk %}" method="post" class="clear-button">
                    {% csrf_token %}
                    <button type="submit" class="btn btn--reset btn--simple">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
                </form>
                <form id="chat-form" method="post" class="chat__form form" >
                    {% csrf_token %}
                    
                    <div class="chat__input">
                        <input type="text" name="message" id="message-input" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
                        <button type="submit" class="btn btn--reset btn--simple btn--primary" id="submit-btn">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="loader"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Å–∏—Å—Ç–µ–º–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
        <div class="page__info info-page info-page--content _jc-fs">
            <span class="info-page__banner info-page__banner--medium">—Ä–µ—Ç—Ä–∏–≤–µ—Ä—ã</span>
            <div class="info-page__header">
                <h2 class="page__heading _ta-e"></h2>
                <h3 class="info-page__heading"></h3>
            </div>
            <div class="info-page__body">
                <div class="info-page__block">
                    <label class="switch" title="–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ MultiRetrievalQAChain">
                        <span class="switch__label">multichain</span>
                        <div class="switch__wrapper">
                            <input class="switch__input visually-hidden" type="radio" name="retriver_scheme" data-validate-field="retriver_scheme" id="id_multichain" checked="">
                            <svg class="switch__icon switch__icon_off" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16 8C16 12.4183 12.4183 16 8 16C3.58172 16 0 12.4183 0 8C0 3.58172 3.58172 0 8 0C12.4183 0 16 3.58172 16 8ZM2 8C2 11.3137 4.68629 14 8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8Z"></path>
                            </svg>
                            <div class="switch__body">
                                <div class="switch__slider"></div>
                            </div>
                            <svg class="switch__icon switch__icon_on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 1 1 16 0zM2 8a6 6 0 1 0 12 0A6 6 0 1 0 2 8zm10 0a4 4 0 1 1-8 0 4 4 0 1 1 8 0z"></path>
                            </svg>
                        </div>
                    </label>
                    <label class="switch" title="–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω EnsembleRetriever">
                        <span class="switch__label">ensemble</span>
                        <div class="switch__wrapper">
                            <input class="switch__input visually-hidden" type="radio" name="retriver_scheme" data-validate-field="retriver_scheme" id="id_ensemble">
                            <svg class="switch__icon switch__icon_off" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16 8C16 12.4183 12.4183 16 8 16C3.58172 16 0 12.4183 0 8C0 3.58172 3.58172 0 8 0C12.4183 0 16 3.58172 16 8ZM2 8C2 11.3137 4.68629 14 8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8Z"></path>
                            </svg>
                            <div class="switch__body">
                                <div class="switch__slider"></div>
                            </div>
                            <svg class="switch__icon switch__icon_on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 1 1 16 0zM2 8a6 6 0 1 0 12 0A6 6 0 1 0 2 8zm10 0a4 4 0 1 1-8 0 4 4 0 1 1 8 0z"></path>
                            </svg>
                        </div>
                    </label>
                </div>
            </div>
            <div class="info-page__footer">
            </div>
        </div>
    </div>
    <div class="page__content">
        <div class="page__info info-page info-page--border _mb">
            <div class="info-page__header">
                <h3 class="info-page__heading _ta-e">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ü–µ–ø–æ—á–∫–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</h3>
            </div>
            <div class="info-page__body">
                <div class="assistant-tree">
                    <div class="assistant-form"></div>
                    <ul class="assistant-tree__list">
                        {% for block in assistant_structure %}
                            <li class="assistant-tree__item" data-item-id="{{ block.id }}">
                                <div class="assistant-tree__header">
                                    <p>
                                        <span class="assistant-tree__name">{{ block.name }}</span>
                                        <span class="assistant-tree__type assistant-tree__type--{{ block.block_type }}">
                                            {{ block.block_type }}
                                        </span>
                                    </p>
                                    <span class="assistant-tree__icon assistant-tree__icon--changed" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–∫–∞ –∏–∑–º–µ–Ω–µ–Ω—ã" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–∫–∞ –∏–∑–º–µ–Ω–µ–Ω—ã">
                                        <svg >
                                            <use xlink:href="{% static 'img/icons/sprite.svg' %}#bugs"></use>
                                        </svg>
                                    </span>
                                    {% if block.config %}
                                    <a href="{% url 'ai-assistants:block-config-update' block.id %}" class="btn btn--reset btn--round" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–∫–∞" aria-label="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–∫–∞">
                                            <svg class="btn__icon">
                                                <use xlink:href="{% static 'img/icons/sprite.svg' %}#edit-gear"></use>
                                            </svg>
                                        </a>
                                    {% endif %}
                                </div>
                                {% if block.function_source or block.config or block.runtime_form%}
                                    <button class="assistant-tree__toggle-function">
                                        –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–∫–∞
                                    </button>
                                {% endif %}
                                
                                {% if block.config %}
                                    <div class="assistant-tree__config">
                                        <span class="assistant-tree__subheading">–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–ª–æ–∫–∞</span>
                                        <ul>
                                            {% for key, value in block.config.items %}
                                                <li>
                                                    <strong>{{ key }}</strong>:
                                                    {% if value.items %}
                                                        <ul>
                                                        {% for k, v in value.items %}
                                                            <li>{{ k }}: {{ v|linebreaksbr }}</li>
                                                        {% endfor %}
                                                        </ul>
                                                    {% else %}
                                                        {{ value|linebreaksbr }}
                                                    {% endif %}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                        
                                    </div>
                                {% endif %}

                                {% if block.runtime_form %}
                                    <div class="assistant-tree__config">
                                        <span class="assistant-tree__subheading">—Ñ–æ—Ä–º–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–∫–∞</span>
                                        <div class="block" id="block-{{ block.id }}">
                                            {% for key, field in block.runtime_form.items %}
                                                <div class="field-container field-container_wide">
                                                    <label class="custom-field" for="{{ field.id }}">
                                                        {% if field.value|length > 100 %}
                                                            <textarea class="custom-field__input custom-field__input_textarea custom-field__input_wide"
                                                                    type="{{ field.type }}"
                                                                    name="{{ field.name }}"
                                                                    id="{{ field.id }}"
                                                                    data-original="{{ field.value }}"
                                                                    {% if field.required %} required {% endif %}
                                                                    placeholder="">{{ field.value|default:"" }}</textarea>
                                                        {% else %}
                                                            <input class="custom-field__input custom-field__input_wide"
                                                                type="{{ field.type }}"
                                                                name="{{ field.name }}"
                                                                id="{{ field.id }}"
                                                                value="{{ field.value }}"
                                                                data-original="{{ field.value }}"
                                                                {% if field.required %} required {% endif %}
                                                                placeholder=""/>
                                                        {% endif %}
                                                        <span class="custom-field__placeholder">{{ key }}</span>
                                                        {% if field.errors %}
                                                        <span class="custom-field__error-message" aria-live="polite">{{ field.errors }}</span>
                                                        {% endif %}
                                                    </label>
                                                </div>
                                            {% endfor %}
                                        </div>
                                            
                                    </div>
                                {% endif %}
                                
                                {% if block.function_source  %}
                                    <div class="assistant-tree__config assistant-tree__function">
                                        <span class="assistant-tree__subheading">–§—É–Ω–∫—Ü–∏—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è Langchain —Ü–µ–ø–æ—á–∫–∏</span>
                                        <div class="assistant-tree__code codehilite">
                                            {{ block.function_source|safe }}
                                        </div>
                                    </div>
                                {% endif %}
                                
                                {% if block.children %}
                                    {% include "app_ai_assistants/include/block_children.html" with blocks=block.children %}
                                {% endif %}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        <div class="page__info info-page info-page--border _mb">
            <div class="info-page__header">
                <h3 class="info-page__heading _ta-e">–†–∞—Å—à–∏—Ä–µ–Ω—ã–π –ª–æ–≥ –ø–æ –æ—Ç–≤–µ—Ç—É —Ü–µ–ø–æ—á–∫–∏</h3>
            </div>
            <div class="info-page__body" id="extended_log">
            </div>
        </div>
    </div>
</div>
{% endblock content %}


{% block script %}
<script src="{% static 'libs/choices/choices.min.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–ª–æ–∫–æ–≤ –æ—Ç –±–∞–∑–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –≤ —Å–∏—Å—Ç–µ–º–µ)

        function normalize(str) {
            return str.replace(/\r\n/g, '\n')   // CRLF ‚Üí LF
                    .replace(/\s+$/g, '')    // —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–Ω—Ü–µ
                    .replace(/^\s+/g, '');   // —É–¥–∞–ª–∏—Ç—å –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ
        }
        document.querySelectorAll(".block").forEach(block => {
            const item = block.closest(".assistant-tree__item");
            if (!item) return; // –µ—Å–ª–∏ item –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –≤—ã—Ö–æ–¥–∏–º
            const icon = item.querySelector(".assistant-tree__icon--changed");
            if (!icon) return; // –µ—Å–ª–∏ –∏–∫–æ–Ω–∫–∏ –Ω–µ—Ç, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º

            const fields = block.querySelectorAll(".custom-field__input");

            // –µ–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–ª–æ–∫–∞
            const checkChanged = () => {
                let hasChanged = false;

                fields.forEach(field => {
                    const changed = normalize(field.value) !== normalize(field.dataset.original ?? "");
                    if (changed) {
                        field.classList.add("custom-field__input--changed");
                        hasChanged = true;
                    } else {
                        field.classList.remove("custom-field__input--changed");
                    }
                });

                if (hasChanged) {
                    item.classList.add("assistant-tree__item--changed");
                    icon.classList.add("assistant-tree__icon--active");
                } else {
                    item.classList.remove("assistant-tree__item--changed");
                    icon.classList.remove("assistant-tree__icon--active");
                }
            };

            // –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è –Ω–∞ –æ–¥–Ω—É —Ñ—É–Ω–∫—Ü–∏—é
            fields.forEach(field => {
                field.addEventListener("input", checkChanged);
                field.addEventListener("change", checkChanged);
            });
        });
        // –†–∞—Å–∫—Ä—ã—Ç–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –±–ª–æ–∫–æ–≤
        document.querySelectorAll('.assistant-tree__toggle-function').forEach(button => {
            button.addEventListener('click', () => {
                button.classList.toggle('assistant-tree__toggle-function--open');
                
                const isOpen = button.classList.contains('assistant-tree__toggle-function--open');
                button.textContent = isOpen ? '–°–∫—Ä—ã—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–∫–∞' : '–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–ª–æ–∫–∞';
                
                const parentItem = button.closest('.assistant-tree__item');
                const configDivs = Array.from(parentItem.children)
                            .filter(child => child.classList.contains('assistant-tree__config'));
                
                configDivs.forEach(configDiv => {
                    configDiv.classList.toggle("assistant-tree__config--active");
                    if (configDiv.style.maxHeight) {
                        configDiv.style.maxHeight = null;
                        configDiv.style.padding = '0 10px';
                    } else {
                        configDiv.style.maxHeight = configDiv.scrollHeight + 20 + 'px';
                        configDiv.style.padding = '10px 10px';
                    }
                });
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π —á–∞—Ç–∞
        const chatForm = document.querySelector("#chat-form");
        const chatHistory = document.getElementById("chat-history");
        const docsContainer = document.getElementById("current-docs");
        const messageInput = document.getElementById("message-input");
        const submitBtn = document.getElementById("submit-btn");
        const loader = document.getElementById("loader");
        const logContainer = document.querySelector("#extended_log");

        const systemInstructionStandard = document.querySelector("#id_system_instruction");
        const llm = document.querySelector("#id_llm");


        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è choice.js –¥–ª—è #id_llm
        if (llm) {
            const llmSelect = new Choices(llm, {
                allowHTML: true,
                classNames: {
                    containerOuter: 'choices custom-choices custom-choices_transparent',
                },
                position: 'down',
                itemSelectText: '–í—ã–±–µ—Ä–∏—Ç–µ llm',
                searchEnabled: true,
                searchPlaceholderValue: '–ø–æ–∏—Å–∫',
                maxItemText: '–í—ã–±—Ä–∞–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ',
                // removeItemButton: true,
                noResultsText: '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
            });
        }

        if (chatHistory) {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function generateStarsHtml(messageId, score) {
            const stars = [];
            for (let i = 2; i >= -2; i--) {
                stars.push(`
                    <label class="rating__star">
                        <input type="radio" class="rating__input" name="score-${messageId}" value="${i}" data-message-id="${messageId}" ${score === i ? 'checked' : ''}>
                    </label>
                `);
            }
            return `<div class="rating__stars">${stars.join('')}</div>`;
        }

        chatHistory.addEventListener("change", function (event) {
            const target = event.target;
            if (!target.classList.contains("rating__input")) return;
            const star = target;
            const container = star.closest(".message");
            const messageId = container?.dataset.messageId;
            const requestUrl = container?.dataset.url;
            if (!messageId || !requestUrl) return;

            const score = parseInt(star.value);
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch(requestUrl, {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrfToken,
                },
                body: new URLSearchParams({ score: score })
            })
            .then(response => {
                if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ü–µ–Ω–∫–∏.");
                const ratingDiv = container.querySelector(".rating");
                if (ratingDiv) {
                    ratingDiv.dataset.score = score;
                    ratingDiv.innerHTML = generateStarsHtml(messageId, score);
                }
                
            })
            .catch(err => {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", err);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ü–µ–Ω–∫–∏.");
            });
        });

        /**
        * –†–µ–Ω–¥–µ—Ä –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã –∏ –±–ª–æ–∫–æ–≤ –¥–µ—Ä–µ–≤–∞
        * @param {string[]} formErrors - –º–∞—Å—Å–∏–≤ –æ–±—â–∏—Ö –æ—à–∏–±–æ–∫ —Ñ–æ—Ä–º—ã
        * @param {Object.<string, string[]>} blockErrors - –æ—à–∏–±–∫–∏ –ø–æ –±–ª–æ–∫–∞–º (–∫–ª—é—á = id –±–ª–æ–∫–∞)
        */
        function renderAssistantErrors(formErrors = [], blockErrors = {}) {
            // 1. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ—à–∏–±–æ–∫
            document.querySelectorAll(".assistant-form-errors, .assistant-tree__block-errors")
                .forEach(el => el.remove());

            let firstErrorEl = null;

            // 2. –û–±—â–∏–µ –æ—à–∏–±–∫–∏ —Ñ–æ—Ä–º—ã
            if (formErrors.length > 0) {
                const ul = document.createElement("ul");
                ul.className = "assistant-form-errors";

                formErrors.forEach(err => {
                    const li = document.createElement("li");
                    li.className = "assistant-form-errors__item";
                    li.innerHTML = err;
                    ul.appendChild(li);
                });

                const form = document.querySelector(".assistant-form");
                if (form) {
                    form.prepend(ul);
                    firstErrorEl = ul;
                }
            }

            // 3. –û—à–∏–±–∫–∏ –ø–æ –±–ª–æ–∫–∞–º
            Object.entries(blockErrors).forEach(([itemId, errors]) => {
                const item = document.querySelector(`.assistant-tree__item[data-item-id="${itemId}"]`);
                if (!item || errors.length === 0) return;

                const ul = document.createElement("ul");
                ul.className = "assistant-tree__block-errors";

                errors.forEach(err => {
                    const li = document.createElement("li");
                    li.className = "assistant-tree__block-error";
                    li.innerHTML = err;
                    ul.appendChild(li);
                });

                item.prepend(ul);

                if (!firstErrorEl) {
                    firstErrorEl = ul;
                }
            });

            // 4. –°–∫—Ä–æ–ª–ª –∫ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
            if (firstErrorEl) {
                firstErrorEl.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }

        /**
        * –†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —Å–ª–æ–≤–∞—Ä—è/–º–∞—Å—Å–∏–≤–∞ –≤ HTML
        */
        function renderDict(data) {
            if (data === null || data === undefined) {
                return `<span class="json__null">null</span>`;
            }

            if (typeof data !== "object") {
                return renderValue(data);
            }

            if (Array.isArray(data)) {
                return `
                    <span class="json__array">[
                        <div class="json__indent">
                            ${data.map((item, i) => `
                                ${renderDict(item)}${i < data.length - 1 ? "," : ""}
                            `).join("")}
                        </div>
                    ]</span>
                `;
            }

            // –æ–±—ä–µ–∫—Ç (dict)
            return `
                {
                <div class="json__indent">
                    ${Object.entries(data).map(([key, value], i, arr) => `
                        <div>
                            <span class="json__key">"${key}"</span>: ${renderDict(value)}${i < arr.length - 1 ? "," : ""}
                        </div>
                    `).join("")}
                </div>
                }
            `;
        }

        function renderValue(value) {
            if (typeof value === "string") {
                if (isUrl(value)) {
                    return `<a href="${value}" class="json__string">${value}</a>`;
                }
                return `<span class="json__string">"${value}"</span>`;
            }
            if (typeof value === "number") {
                return `<span class="json__number">${value}</span>`;
            }
            if (typeof value === "boolean") {
                return `<span class="json__bool">${value}</span>`;
            }
            return `<span class="json__string">${value}</span>`;
        }

        function isUrl(str) {
            try {
                new URL(str);
                return true;
            } catch {
                return false;
            }
        }


        chatForm.addEventListener("submit", function (e) {
            e.preventDefault();

            // –æ—á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–µ –æ—à–∏–±–∫–∏
            renderAssistantErrors();

            logContainer.innerHTML = "";


            const message = messageInput.value.trim();
            if (!message) return;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '–û–±—Ä–∞–±–æ—Ç–∫–∞... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            loader.classList.remove("d-none");

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            const multichainScheme = document.querySelector("#id_multichain").checked;
            const ensembleScheme = document.querySelector("#id_ensemble").checked;

            // üîπ –°–æ–±–∏—Ä–∞–µ–º –∏–∑–º–µ–Ω—ë–Ω–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –±–ª–æ–∫–æ–≤ 
            const runtimeConfig = {};
            document.querySelectorAll(".assistant-tree__item--changed").forEach(item => {
                const block = item.querySelector(".block");
                if (!block) return;
                const blockId = block.id.replace("block-", "");
                const fields = block.querySelectorAll(".custom-field__input");

                runtimeConfig[blockId] = {};
                fields.forEach(f => {
                    if (normalize(f.value) !== normalize(f.dataset.original ?? "")) {
                        runtimeConfig[blockId][f.name] = f.value;
                    }
                });

                if (Object.keys(runtimeConfig[blockId]).length === 0) {
                    delete runtimeConfig[blockId];
                }
            });

            // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä AI
            messageInput.value = "";
            const tempUserMsg = `<div class="message message--user">${message}</div>`;
            const tempBotMsgId = `temp-bot-${Date.now()}`;
            const tempBotMsg = `
                <div class="message message--ai" id="${tempBotMsgId}">
                    <div class="message__typing-indicator">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            chatHistory.innerHTML += tempUserMsg + tempBotMsg;
            chatHistory.scrollTop = chatHistory.scrollHeight;

            fetch("", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrfToken,
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: new URLSearchParams({
                    message,
                    is_multichain: multichainScheme.toString(),
                    is_ensemble: ensembleScheme.toString(),
                    runtime_config: JSON.stringify(runtimeConfig),
                })
            })
            .then(response => response.json().then(data => ({ status: response.status, data })))
            .then(({ status, data }) => {
                if (status >= 400) {
                    // –æ—à–∏–±–∫–∏ runtime_config –∏–ª–∏ —Ñ–æ—Ä–º—ã
                    if (data.details || data.form_errors) {
                        renderAssistantErrors(data.form_errors || [], data.details || {});
                        return false; // –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–ª—å–Ω–µ–π—à—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É
                    }

                    // –Ω–∞—Å—Ç–æ—è—â–∏–µ –æ—à–∏–±–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
                    renderAssistantErrors([data.error || "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"], {});
                    return false;
                }

                return data; // —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç
            })
            .then(data => {
                if (!data) return;
                const { ai_response, extended_log } = data;

                // –ó–∞–º–µ–Ω—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç AI
                const botMsgEl = document.getElementById(tempBotMsgId);
                if (botMsgEl) {
                    botMsgEl.outerHTML = `
                        <div class="message message--ai" data-message-id="${ai_response.id}" data-url="${ai_response.request_url}">
                            ${ai_response.text}
                            <div class="rating" data-score="${ai_response.score ?? ''}">
                                ${generateStarsHtml(ai_response.id, ai_response.score)}
                            </div>
                        </div>
                    `;
                }

                chatHistory.scrollTop = chatHistory.scrollHeight;
                // –†–µ–Ω–¥–µ—Ä –ª–æ–≥–∞
                if (logContainer) {
                    logContainer.innerHTML = extended_log
                        ? renderDict(extended_log)
                        : "<p class='text-muted'>–ù–µ—Ç –ª–æ–≥–∞.</p>";
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞:", error);
                //alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞."); // —Å–µ—Ç–µ–≤—ã–µ –∏ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏.
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                loader.classList.add("d-none");
            });
        });

    });
</script>

{% endblock script %}

