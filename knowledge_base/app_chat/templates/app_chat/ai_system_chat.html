{% extends 'clear_base.html' %}
{% load static %}
{% load custom_filters %}


{% block extra_css %}
    <link href="{% static 'libs/choices/choices.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/custom_choices.css' %}" rel="stylesheet">
    <link href="{% static 'css/chat.css' %}" rel="stylesheet">
{% endblock %}


{% block nav %}
    {% include "include/nav.html" %}
{% endblock nav %}


{% block title %}–ß–∞—Ç —Å AI{% endblock %}


{% block content %}
<div class="page page--kb">
    <div class="page__top page__top--system-chat">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ß–∞—Ç -->
        <div class="chat">
            <div class="chat__header">
                <h3 class="chat__heading">üß† Ask {{ kb.engine.name }}</h3>
                <span class="text text--muted">Embedded by: <span class="text text--fat text--muted">{{ kb.engine.model_name }}</span></span>
                <span class="text text--muted _mb">Answer by: <span class="text text--fat text--muted">OpenAI/gpt-4o-mini</span></span>
            </div>
            <div class="chat__history" id="chat-history">
                {% for message in chat_history %}
                    <div class="message {% if message.is_user %} message--user{% else %} message--ai{% endif %}" data-message-id="{{ message.id }}" data-url="{% url 'chat:message_score' message.id %}">
                        {{ message.text|safe }}
                        {% if not message.is_user %}
                            <div class="rating" data-score="{{ message.score|default_if_none:'' }}">
                                <div class="rating__stars">
                                    {% for i in "2 1 0 -1 -2"|split:" " %}
                                        {% with i_int=i|add:"0" %}
                                            <label class="rating__star">
                                                <input type="radio" class="rating__input" name="score-{{ message.id }}" value="{{ i_int }}" {% if message.score == i_int%} checked{% endif %}>
                                            </label>
                                        {% endwith %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
            <div class="chat__footer">
                <form action="{% url 'chat:clear_chat' kb.pk %}" method="post" class="clear-button">
                    {% csrf_token %}
                    <button type="submit" class="btn btn--reset btn--simple">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
                </form>
                <form id="chat-form" method="post" class="chat__form form" >
                    {% csrf_token %}
                    
                    <div class="chat__input">
                        <input type="text" name="message" id="message-input" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
                        <button type="submit" class="btn btn--reset btn--simple btn--primary" id="submit-btn">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="loader"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Å–∏—Å—Ç–µ–º–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
        <div class="page__info info-page info-page--content _jc-fs">
            <span class="info-page__banner info-page__banner--medium">–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</span>
            <div class="info-page__header">
                <h2 class="page__heading _ta-e"></h2>
                <h3 class="info-page__heading"></h3>
            </div>
            <div class="info-page__body">
                {% include "widgets/_form_content-widget.html" with form=system_instruction_form %}
            </div>
            <div class="info-page__footer">
                <div class="info-page__manage">
                    <div class="info-page__block">
                        <label class="switch" title="–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ MultiRetrievalQAChain">
                            <span class="switch__label">multichain</span>
                            <div class="switch__wrapper">
                                <input class="switch__input visually-hidden" type="radio" name="retriver_scheme" data-validate-field="retriver_scheme" id="id_multichain" checked="">
                                <svg class="switch__icon switch__icon_off" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M16 8C16 12.4183 12.4183 16 8 16C3.58172 16 0 12.4183 0 8C0 3.58172 3.58172 0 8 0C12.4183 0 16 3.58172 16 8ZM2 8C2 11.3137 4.68629 14 8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8Z"></path>
                                </svg>
                                <div class="switch__body">
                                    <div class="switch__slider"></div>
                                </div>
                                <svg class="switch__icon switch__icon_on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 1 1 16 0zM2 8a6 6 0 1 0 12 0A6 6 0 1 0 2 8zm10 0a4 4 0 1 1-8 0 4 4 0 1 1 8 0z"></path>
                                </svg>
                            </div>
                        </label>
                        <label class="switch" title="–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω EnsembleRetriever">
                            <span class="switch__label">ensemble</span>
                            <div class="switch__wrapper">
                                <input class="switch__input visually-hidden" type="radio" name="retriver_scheme" data-validate-field="retriver_scheme" id="id_ensemble">
                                <svg class="switch__icon switch__icon_off" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M16 8C16 12.4183 12.4183 16 8 16C3.58172 16 0 12.4183 0 8C0 3.58172 3.58172 0 8 0C12.4183 0 16 3.58172 16 8ZM2 8C2 11.3137 4.68629 14 8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8Z"></path>
                                </svg>
                                <div class="switch__body">
                                    <div class="switch__slider"></div>
                                </div>
                                <svg class="switch__icon switch__icon_on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 1 1 16 0zM2 8a6 6 0 1 0 12 0A6 6 0 1 0 2 8zm10 0a4 4 0 1 1-8 0 4 4 0 1 1 8 0z"></path>
                                </svg>
                            </div>
                        </label>
                        <label class="switch" title="–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω TrigramSimilarity PostgreSQL">
                            <span class="switch__label">TrigramSimilarity</span>
                            <div class="switch__wrapper">
                                <input class="switch__input visually-hidden" type="radio" name="retriver_scheme" data-validate-field="retriver_scheme" id="id_trigram">
                                <svg class="switch__icon switch__icon_off" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M16 8C16 12.4183 12.4183 16 8 16C3.58172 16 0 12.4183 0 8C0 3.58172 3.58172 0 8 0C12.4183 0 16 3.58172 16 8ZM2 8C2 11.3137 4.68629 14 8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8Z"></path>
                                </svg>
                                <div class="switch__body">
                                    <div class="switch__slider"></div>
                                </div>
                                <svg class="switch__icon switch__icon_on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 1 1 16 0zM2 8a6 6 0 1 0 12 0A6 6 0 1 0 2 8zm10 0a4 4 0 1 1-8 0 4 4 0 1 1 8 0z"></path>
                                </svg>
                            </div>
                        </label>
                    </div>
                    <div class="info-page__block">
                        <label class="switch" title="–ü—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞">
                            <span class="switch__label">reformulate question</span>
                            <div class="switch__wrapper">
                                <input class="switch__input visually-hidden" type="checkbox" name="reformulate_question" data-validate-field="reformulate_question" id="id_reformulate_question">
                                <svg class="switch__icon switch__icon_off" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M16 8C16 12.4183 12.4183 16 8 16C3.58172 16 0 12.4183 0 8C0 3.58172 3.58172 0 8 0C12.4183 0 16 3.58172 16 8ZM2 8C2 11.3137 4.68629 14 8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8Z"></path>
                                </svg>
                                <div class="switch__body">
                                    <div class="switch__slider"></div>
                                </div>
                                <svg class="switch__icon switch__icon_on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                    <path d="M16 8A8 8 0 1 1 0 8a8 8 0 1 1 16 0zM2 8a6 6 0 1 0 12 0A6 6 0 1 0 2 8zm10 0a4 4 0 1 1-8 0 4 4 0 1 1 8 0z"></path>
                                </svg>
                            </div>
                        </label>
                        <label class="custom-field" title="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä –≤–æ–ø—Ä–æ—Å-–æ—Ç–≤–µ—Ç –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞">
                            <span class="custom-field__label">–ì–ª—É–±–∏–Ω–∞ –∏—Å—Ç–æ—Ä–∏–∏</span>
                            <input type="number" name="name" class="custom-field__input custom-field__input_wide" value=3 min="1" max="10" required="" id="id_history_deep">
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="page__content">
        <div class="d-flex gap-2 mt-2 mb-2">
            {% comment %} <a href="{% url 'chunks:current_chuncks' %}" class="btn btn-outline-secondary btn-sm">–î–µ–π—Å—Ç–≤—É—é—â–∏–µ —á–∞–Ω–∫–∏</a> {% endcomment %}
            {% comment %} <a href="{% url 'chunks:test_model_score' %}" class="btn btn-outline-secondary btn-sm">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å</a> {% endcomment %}
        </div>
        <div class="col-md-6" id="docs-column">
            <h4>üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h4>
            <div id="current-docs" class="bg-light border rounded p-3">
                <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
            </div>
        </div>
    </div>
</div>
{% endblock content %}


{% block script %}
<script src="{% static 'libs/choices/choices.min.js' %}"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const chatForm = document.querySelector("#chat-form");
    const chatHistory = document.getElementById("chat-history");
    const docsContainer = document.getElementById("current-docs");
    const messageInput = document.getElementById("message-input");
    const submitBtn = document.getElementById("submit-btn");
    const loader = document.getElementById("loader");

    const systemInstructionStandard = document.querySelector("#id_system_instruction");
    const llm = document.querySelector("#id_llm");


    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è choice.js –¥–ª—è #id_llm
    if (llm) {
        const llmSelect = new Choices(llm, {
            allowHTML: true,
            classNames: {
                containerOuter: 'choices custom-choices custom-choices_transparent',
            },
            position: 'down',
            itemSelectText: '–í—ã–±–µ—Ä–∏—Ç–µ llm',
            searchEnabled: true,
            searchPlaceholderValue: '–ø–æ–∏—Å–∫',
            maxItemText: '–í—ã–±—Ä–∞–Ω–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –¥–æ–ø—É—Å—Ç–∏–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ',
            // removeItemButton: true,
            noResultsText: '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
        });
    }

    if (chatHistory) {
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    function generateStarsHtml(messageId, score) {
        const stars = [];
        for (let i = 2; i >= -2; i--) {
            stars.push(`
                <label class="rating__star">
                    <input type="radio" class="rating__input" name="score-${messageId}" value="${i}" data-message-id="${messageId}" ${score === i ? 'checked' : ''}>
                </label>
            `);
        }
        return `<div class="rating__stars">${stars.join('')}</div>`;
    }

    chatHistory.addEventListener("change", function (event) {
        const target = event.target;
        if (!target.classList.contains("rating__input")) return;
        const star = target;
        const container = star.closest(".message");
        const messageId = container?.dataset.messageId;
        const requestUrl = container?.dataset.url;
        if (!messageId || !requestUrl) return;

        const score = parseInt(star.value);
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        fetch(requestUrl, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrfToken,
            },
            body: new URLSearchParams({ score: score })
        })
        .then(response => {
            if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ü–µ–Ω–∫–∏.");
            const ratingDiv = container.querySelector(".rating");
            if (ratingDiv) {
                ratingDiv.dataset.score = score;
            }
            
        })
        .catch(err => {
            console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", err);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ü–µ–Ω–∫–∏.");
        });
    });

    chatForm.addEventListener("submit", function (e) {
        e.preventDefault();

        const message = messageInput.value.trim();
        if (!message) return;

        submitBtn.disabled = true;
        submitBtn.innerHTML = '–û–±—Ä–∞–±–æ—Ç–∫–∞... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
        loader.classList.remove("d-none");

        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        const systemStandard = systemInstructionStandard.value;
        const llm_name = llm.value;
        const multichainScheme = document.querySelector("#id_multichain").checked;
        const ensembleScheme = document.querySelector("#id_ensemble").checked;
        const trigramScheme = document.querySelector("#id_trigram").checked;
        const reformulateQuestion = document.querySelector("#id_reformulate_question").checked;
        const historyDeep = document.querySelector("#id_history_deep").value;


        // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        messageInput.value = "";
        const tempUserMsg = `<div class="message message--user">${message}</div>`;
        const tempBotMsgId = `temp-bot-${Date.now()}`;
        const tempBotMsg = `
            <div class="message message--ai" id="${tempBotMsgId}">
                <div class="message__typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        chatHistory.innerHTML += tempUserMsg + tempBotMsg;
        chatHistory.scrollTop = chatHistory.scrollHeight;

        fetch("", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrfToken,
                "X-Requested-With": "XMLHttpRequest"
            },
            body: new URLSearchParams({
                message,
                system_instruction: systemStandard,
                llm: llm_name,
                is_multichain: multichainScheme.toString(),
                is_ensemble: ensembleScheme.toString(),
                is_trigram: trigramScheme.toString(),
                is_reformulate_question: reformulateQuestion.toString(),
                history_deep: historyDeep.toString(),
            })
        })
        .then(response => response.json())
        .then(data => {
            const { ai_response, current_docs } = data;

            // –ó–∞–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç AI –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π
            const botMsgEl = document.getElementById(tempBotMsgId);
            if (botMsgEl) {
                botMsgEl.outerHTML = `
                    <div class="message message--ai" data-message-id="${ai_response.id}" data-url="${ai_response.request_url}">
                        ${ai_response.text}
                        <div class="rating" data-score="${ai_response.score ?? ''}">
                            ${generateStarsHtml(ai_response.id, ai_response.score)}
                        </div>
                    </div>
                `;
            }

            chatHistory.scrollTop = chatHistory.scrollHeight;

            docsContainer.innerHTML = Array.isArray(current_docs) && current_docs.length > 0
                ? current_docs.map((doc, i) => `
                    <div class="mb-3 p-2 border rounded bg-white">
                        <strong>–î–æ–∫—É–º–µ–Ω—Ç ${i + 1}</strong><br/>
                        <pre class="mb-0 text-break" style="white-space:pre-wrap;">${JSON.stringify(doc, null, 2)}</pre>
                    </div>
                `).join('')
                : "<p class='text-muted'>–ù–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.</p>";
        })
        .catch(error => {
            console.error("–û—à–∏–±–∫–∞:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞.");
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            loader.classList.add("d-none");
        });
    });

});
</script>

{% endblock script %}

