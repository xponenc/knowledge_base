{% extends 'clear_base.html' %}
{% load static %}
{% load custom_filters %}


{% block extra_css %}
    <link href="{% static 'css/chat.css' %}" rel="stylesheet">
{% endblock %}


{% block nav %}
    {% include "include/nav.html" %}
{% endblock nav %}


{% block title %}–ß–∞—Ç —Å AI{% endblock %}


{% block content %}
<div class="page page--kb">
    <div class="page__top">
        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ß–∞—Ç -->
        <div class="chat">
            <div class="chat__header">
                <h3 class="chat__heading">üß† Ask {{ kb.engine.name }}</h3>
                <span class="text text--muted">Embedded by: <span class="text text--fat text--muted">{{ kb.engine.model_name }}</span></span>
                <span class="text text--muted _mb">Answer by: <span class="text text--fat text--muted">OpenAI/gpt-4o-mini</span></span>
            </div>

            <div class="chat__history" id="chat-history">
                {% for message in chat_history %}
                    <div class="message message--user">{{ message.user|safe }}</div>
                    <div class="message message--ai" data-message-id="{{ message.id }}">
                        {{ message.ai|safe }}
                        <div class="rating" data-score="{{ message.score|default_if_none:'' }}">
                            <div class="rating__stars">
                                {% for i in "-2 -1 0 1 2"|split:" " %}
                                    {% with i_int=i|add:"0" %}
                                    <span 
                                        class="rating__star {% if message.score == i_int %}rating__star--active{% endif %}" 
                                        data-value="{{ i_int }}" 
                                        data-message-id="{{ message.id }}"
                                        title="{{ i_int }}"
                                        style="cursor: {% if message.score is not None %}default{% else %}pointer{% endif %};"
                                    >‚òÖ</span>
                                    {% endwith %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
            <div class="chat__footer">
                <form action="{% url 'embeddings:clear_chat' %}" method="post" class="clear-button">
                    {% csrf_token %}
                    <button type="submit" class="btn btn--reset btn--simple">–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç</button>
                </form>
                <form id="chat-form" method="post" class="chat__form form" >
                    {% csrf_token %}
                    <label class="switch">
                        <span class="switch__label">–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å metadata</span>
                        <div class="switch__wrapper">
                            <input class="switch__input visually-hidden" type="checkbox" name="use_metadata" data-validate-field="use_metadata" id="id_use_metadata" checked="">
                            <svg class="switch__icon switch__icon_off" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg">
                                <path d="M16 8C16 12.4183 12.4183 16 8 16C3.58172 16 0 12.4183 0 8C0 3.58172 3.58172 0 8 0C12.4183 0 16 3.58172 16 8ZM2 8C2 11.3137 4.68629 14 8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8Z"></path>
                            </svg>
                            <div class="switch__body">
                                <div class="switch__slider"></div>
                            </div>
                            <svg class="switch__icon switch__icon_on" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 1 1 16 0zM2 8a6 6 0 1 0 12 0A6 6 0 1 0 2 8zm10 0a4 4 0 1 1-8 0 4 4 0 1 1 8 0z"></path>
                            </svg>
                        </div>
                    </label>
                    <div class="chat__input">
                        <input type="text" name="message" id="message-input" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
                        <button type="submit" class="btn btn--reset btn--simple btn--primary" id="submit-btn">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="loader"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <div class="page__content">
        <div class="d-flex gap-2 mt-2 mb-2">
            {% comment %} <a href="{% url 'chunks:current_chuncks' %}" class="btn btn-outline-secondary btn-sm">–î–µ–π—Å—Ç–≤—É—é—â–∏–µ —á–∞–Ω–∫–∏</a> {% endcomment %}
            {% comment %} <a href="{% url 'chunks:test_model_score' %}" class="btn btn-outline-secondary btn-sm">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å</a> {% endcomment %}
        </div>
        <div class="col-md-6" id="docs-column">
            <h4>üîç –ù–∞–π–¥–µ–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã</h4>
            <div id="current-docs" class="bg-light border rounded p-3">
                <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
            </div>
        </div>
    </div>
</div>
{% endblock content %}


{% block script %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const chatForm = document.querySelector("#chat-form");
        const chatHistory = document.getElementById("chat-history");
        const docsContainer = document.getElementById("current-docs");
        const messageInput = document.getElementById("message-input");
        const submitBtn = document.getElementById("submit-btn");
        const loader = document.getElementById("loader");
        const urlTemplate = "{% url 'embeddings:message_score' message_pk=0 %}";

        if (chatHistory) {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        function generateStarsHtml(messageId, score) {
            const stars = [];
            for (let i = -2; i <= 2; i++) {
                const active = (i === score) ? 'rating__star--active' : '';
                const disabled = (score !== null && score !== undefined) ? 'rating__star--disabled' : '';
                stars.push(`
                    <span class="rating__star ${active} ${disabled}" 
                        data-message-id="${messageId}" 
                        data-score="${i}" 
                        title="${i}">‚òÖ</span>
                `);
            }
            return stars.join('');
        }

        function setupRatingEvents() {
            document.querySelectorAll(".rating__star").forEach(star => {
                star.addEventListener("click", function () {
                    const container = star.closest(".rating");
                    if (container.dataset.scored === "true") return;

                    const messageId = star.dataset.messageId;
                    if (!messageId) return;

                    const score = star.dataset.score;
                    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                    
                    urlTemplate =  urlTemplate.replace(/0\/?$/, `${messageId}/`);

                    fetch(urlTemplate, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": csrfToken,
                        },
                        body: JSON.stringify({ score: parseInt(score) })
                    })
                    .then(response => {
                        if (response.ok) {
                            container.dataset.scored = "true";
                            container.dataset.score = score;
                            container.innerHTML = generateStarsHtml(messageId, parseInt(score));
                        } else {
                            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ü–µ–Ω–∫–∏.");
                        }
                    })
                    .catch(err => {
                        console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", err);
                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ü–µ–Ω–∫–∏.");
                    });
                });
            });
        }

        chatForm.addEventListener("submit", function (e) {
            e.preventDefault();

            const message = messageInput.value.trim();
            if (!message) return;

            const useMetadata = document.getElementById("id_use_metadata").checked;

            submitBtn.disabled = true;
            submitBtn.innerHTML = '–û–±—Ä–∞–±–æ—Ç–∫–∞... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            loader.classList.remove("d-none");

            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            fetch("", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": csrfToken,
                    "X-Requested-With": "XMLHttpRequest"
                },
                body: new URLSearchParams({
                    message,
                    use_metadata: useMetadata ? "on" : ""
                })
            })
            .then(response => response.json())
            .then(data => {
                const { user_message, ai_response, current_docs } = data;

                chatHistory.innerHTML += `
                    <div class="message message--user">${user_message}</div>
                    <div class="message message--ai">
                        ${ai_response.text}
                        <div class="rating" data-scored="${ai_response.score !== null}" data-score="${ai_response.score ?? ''}">
                            ${generateStarsHtml(ai_response.id, ai_response.score)}
                        </div>
                    </div>
                `;

                chatHistory.scrollTop = chatHistory.scrollHeight;

                if (Array.isArray(current_docs) && current_docs.length > 0) {
                    docsContainer.innerHTML = current_docs.map((doc, i) => `
                        <div class="mb-3 p-2 border rounded bg-white">
                            <strong>–î–æ–∫—É–º–µ–Ω—Ç ${i + 1}</strong><br/>
                            <pre class="mb-0 text-break" style="white-space:pre-wrap;">${JSON.stringify(doc, null, 2)}</pre>
                        </div>
                    `).join('');
                } else {
                    docsContainer.innerHTML = "<p class='text-muted'>–ù–µ—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.</p>";
                }

                messageInput.value = "";
                setupRatingEvents();  // –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –Ω–∞ –Ω–æ–≤—ã–µ –∑–≤—ë–∑–¥–æ—á–∫–∏
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞:", error);
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞.");
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
                loader.classList.add("d-none");
            });
        });

        setupRatingEvents();  // –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ –ø–µ—Ä–≤–∏—á–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ, –µ—Å–ª–∏ –æ—Ü–µ–Ω–∫–∏ —É–∂–µ –µ—Å—Ç—å
    });
</script>
{% endblock script %}

